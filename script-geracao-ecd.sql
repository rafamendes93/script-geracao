select 'CONF' as REG,'0000' as REG_ID, '1'    as REG_PAI, ''  as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'0007' as REG_ID, '1'    as REG_PAI, '0' as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'0020' as REG_ID, '1'    as REG_PAI, '0' as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'0035' as REG_ID, '1'    as REG_PAI, '0' as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'0150' as REG_ID, '1'    as REG_PAI, '0' as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'0180' as REG_ID, '0150' as REG_PAI, '0' as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'0990' as REG_ID, '1'    as REG_PAI, '0' as GRUPO, 'a' as ORDEM UNION ALL
select 'CONF' as REG,'I001' as REG_ID, '1'    as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I010' as REG_ID, '1'    as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I012' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I015' as REG_ID, 'I012' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I020' as REG_ID, 'I015' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I030' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I050' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I051' as REG_ID, 'I050' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I052' as REG_ID, 'I050' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I053' as REG_ID, 'I050' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I075' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I100' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I150' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I155' as REG_ID, 'I150' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I157' as REG_ID, 'I155' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I200' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I250' as REG_ID, 'I200' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I300' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I310' as REG_ID, 'I300' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I350' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I355' as REG_ID, 'I350' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I500' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I510' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I550' as REG_ID, 'I010' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I555' as REG_ID, 'I550' as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'I990' as REG_ID, '1'    as REG_PAI, 'I' as GRUPO, 'b' as ORDEM UNION ALL
select 'CONF' as REG,'J001' as REG_ID, '1'    as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J005' as REG_ID, '1'    as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J100' as REG_ID, 'J005' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J150' as REG_ID, 'J005' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J210' as REG_ID, 'J005' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J215' as REG_ID, 'J210' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J800' as REG_ID, 'J005' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J801' as REG_ID, '1'    as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J900' as REG_ID, '1'    as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J930' as REG_ID, 'J900' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J932' as REG_ID, 'J900' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM UNION ALL
select 'CONF' as REG,'J935' as REG_ID, 'J900' as REG_PAI, 'J' as GRUPO, 'c' as ORDEM

/* Geração Arquivo ECD */

/*sql*/

CREATE FUNCTION dbo.FormatDateDMA (@date DATETIME)
    RETURNS VARCHAR(8)
AS
BEGIN
    RETURN REPLACE(CONVERT(VARCHAR(10), CONVERT(DATE, @date, 112), 103), '/', '')
END

select '1'                                as ID
     , '1'                                as ID_PAI
     , '0000'                             as REG
     , isnull(eecd.lecd, '')              as LECD
     , dbo.FormatDateDMA(eecd.periodo_dtini) as DT_INI
     , dbo.FormatDateDMA(eecd.periodo_dtfin) as DT_FIN
     , isnull(estm.NOME, '')              as NOME
     , isnull(estm.CNPJ, '')              as CNPJ
     , isnull(estm.UF, '')                as UF
     , isnull(estm.IE, '')                as IE
     , isnull(estm.COD_MUN, '')           as COD_MUN
     , isnull(estm.IM, '')                as IM
     , isnull(eecd.IND_SIT_ESP, '')       as IND_SIT_ESP
     , isnull(eecd.IND_SIT_INI_PER, '0')  as IND_SIT_INI_PER
     , isnull(eecd.IND_NIRE, '1')         as IND_NIRE
     , isnull(eecd.IND_FIN_ESC, '0')      as IND_FIN_ESC
     , isnull(eecd.COD_HASH_SUB, '')      as COD_HASH_SUB
     , isnull(eecd.IND_GRANDE_PORTE, '')  as IND_GRANDE_PORTE
     , isnull(eecd.TIP_ECD, '0')          as TIP_ECD
     , isnull(eecd.COD_SCP, '')           as COD_SCP
     , isnull(eecd.IDENT_MF, 'N')         as IDENT_MF
     , isnull(eecd.IND_ESC_CONS, 'N')     as IND_ESC_CONS
     , isnull(eecd.IND_CENTRALIZADA, '0') as IND_CENTRALIZADA
     , isnull(eecd.IND_MUDANCA_PC, '0')   as IND_MUDANC_PC
     , isnull(eecd.COD_PLAN_REF, '1')     as COD_PLAN_REF
from estabelecimento_ecd eecd
         inner Join estabelecimentos estm
                    on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
/*  and eecd.periodo_dtini = substring('/*per_iniAMD*/',1,4) + case when isnull(eecd.forma_apur,'') = 'A' then '01' else right('00' + cast(cast(substring('/*per_iniAMD*/',5,2) As numeric(2,0)) - 2 As varchar(2)),2) End + '01'  */
  and substring(eecd.periodo_dtini, 1, 4) = substring('/*per_iniAMD*/', 1, 4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
/*
where 1 = 1
  and estm.estabelecimento_id = '001'
  and substring(eecd.periodo_dtini,1,4) = substring('20221201',1,4) + case when isnull(eecd.forma_apur,'') = 'A' then '01' else right('00' + cast(cast(substring('20221201',5,2) As numeric(2,0)) - 2 As varchar(2)),2) End + substring('20221201',7,2)
  and periodo_dtfin = '20221231'
*/

/*sql*/

select
 '1' + '.' + isnull(COD_ENT_REF,estm.uf) + '.' + isnull(COD_INSCR,'') as ID
,'1' as ID_PAI

,'0007' as REG
,isnull(COD_ENT_REF,estm.uf) as COD_ENT_REF
,isnull(COD_INSCR,'') as COD_INSCR
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
left  join estabelecimento_outrasinscricoes eoinsc
   on eoinsc.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and isnull(eoinsc.validade_dtini,'') <= eecd.periodo_dtfin
  and isnull(eoinsc.validade_dtfin,'99999999') >= eecd.periodo_dtini
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
/*  and eecd.periodo_dtini = substring('/*per_iniAMD*/',1,4) + case when isnull(eecd.forma_apur,'') = 'A' then '01' else right('00' + cast(cast(substring('/*per_iniAMD*/',5,2) As numeric(2,0)) - 2 As varchar(2)),2) End + '01'  */
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'00' as REG
,'' as IND_DEC
,'' as CNPJ
,'' as UF
,'' as IE
,'' as COD_MUN
,'' as IM
,'' as NIRE
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
/*  and eecd.periodo_dtini = substring('/*per_iniAMD*/',1,4) + case when isnull(eecd.forma_apur,'') = 'A' then '01' else right('00' + cast(cast(substring('/*per_iniAMD*/',5,2) As numeric(2,0)) - 2 As varchar(2)),2) End + '01'  */
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'' as REG
,'' as COD_SCP
,'' as NOME_SCP
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
/*  and eecd.periodo_dtini = substring('/*per_iniAMD*/',1,4) + case when isnull(eecd.forma_apur,'') = 'A' then '01' else right('00' + cast(cast(substring('/*per_iniAMD*/',5,2) As numeric(2,0)) - 2 As varchar(2)),2) End + '01'  */
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

select distinct
 '1' + '.' + part.estabelecimento_matriz_id + '.' + substring(part.COD_PART,1,9) as ID_0150
,'1' as ID_PAI_0150
,'1' + '.' + part.estabelecimento_matriz_id + '.' + substring(part.COD_PART,1,9) + '.' + isnull(partrel.COD_REL,'') as ID_0180
,substring(part.COD_PART,1,9) as COD_PART
,part.NOME as NOME
,right('00000' + isnull(part.COD_PAIS,''),5) as COD_PAIS
,isnull(part.CNPJ,'') as CNPJ
,isnull(part.CPF,'') as CPF
,'' as NIT
,isnull(part.UF,'') as UF
,isnull(part.IE,'') as IE
,'' as IE_ST
,isnull(part.COD_MUN,'') as COD_MUN
,isnull(part.IM,'') as IM
,isnull(part.SUFRAMA,'') as SUFRAMA
,isnull(partrel.cod_rel,'') as COD_REL
,case when len(rtrim(isnull(partrel.dt_ini_rel,''))) <> 8 then '' else replace(convert(varchar(10),convert(date,partrel.dt_ini_rel,112),103),'/','') end as DT_INI_REL
,case when len(rtrim(isnull(partrel.dt_fin_rel,''))) <> 8 then '' else replace(convert(varchar(10),convert(date,partrel.dt_fin_rel,112),103),'/','') end as DT_FIN_REL
/*into tmp_wwreg_0150_0180*/
into TEMP_wwreg_0150_0180
/* -- tabela principal alias eecd */
from estabelecimento_ecd eecd
/* -- join com estabelecimentos */
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join vw_cad_participantes part
   on part.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and isnull(part.validade_dtini,'00000000') <= eecd.periodo_dtfin
  and isnull(part.validade_dtfin,'99999999') >= eecd.periodo_dtini
  and part.uf = 'EX'
inner join participante_relacionamentos partrel
   on part.cod_part like '%' + partrel.participante_id + '%'
  and isnull(partrel.validade_dtini,'00000000') <= eecd.periodo_dtfin
  and isnull(partrel.validade_dtfin,'99999999') >= eecd.periodo_dtini
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
/*  and eecd.periodo_dtini = substring('/*per_iniAMD*/',1,4) + case when isnull(eecd.forma_apur,'') = 'A' then '01' else right('00' + cast(cast(substring('/*per_iniAMD*/',5,2) As numeric(2,0)) - 2 As varchar(2)),2) End + '01'  */
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
  and substring(part.COD_PART,1,9) in
( select distinct
   ecdlct.cod_part
  from ecd_lancamentos ecdlct
  where 1 = 1
    and ecdlct.estabelecimento_matriz_id = '/*empresa_id_vtx*/'
    and len(rtrim(isnull(ecdlct.cod_part,''))) > 0
    and substring(ecdlct.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
/*
    and ecdlct.periodo_dtini = '/*per_iniAMD*/'
    and ecdlct.periodo_dtfin = '/*per_finAMD*/'
*/
)

/*sql*/

select
 ID_0150 as ID
,max(ID_PAI_0150) as ID_PAI

,'0150' as REG
,max(part.COD_PART) as COD_PART
,max(part.NOME) as NOME
,max(part.COD_PAIS) as COD_PAIS
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.CNPJ) End as CNPJ
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.CPF) End as CPF
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.NIT) End as NIT
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.UF) End as UF
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.IE) End as IE
,'' as IE_ST
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.COD_MUN) End as COD_MUN
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.IM) End as IM
,Case When right(max(part.COD_PAIS),4) <> '1058' Then '' Else max(part.SUFRAMA) End as SUFRAMA
/*from tmp_wwreg_0150_0180 part*/
from TEMP_wwreg_0150_0180 part
where part.cod_rel Between '01' And '99'
group by ID_0150
order by ID_0150

/*sql*/

select
 ID_0180 as ID
,ID_0150 as ID_PAI

,'0180' as REG
,part.COD_REL as COD_REL
,part.DT_INI_REL
,part.DT_FIN_REL
/*
,substring(part.dt_ini_rel,7,2)+substring(part.dt_ini_rel,5,2)+substring(part.dt_ini_rel,1,4) as DT_INI_REL
,case when part.dt_fin_rel is null then '' else substring(part.dt_fin_rel,7,2)+substring(part.dt_fin_rel,5,2)+substring(part.dt_fin_rel,1,4) end as DT_FIN_REL
,part.cod_rel as COD_REL
,case when part.dt_ini_rel is null then '' else replace(convert(varchar(10),convert(date,part.dt_ini_rel,112),103),'/','') end as DT_INI_REL
,case when part.dt_ini_rel is null then '' else replace(convert(varchar(10),convert(date,part.dt_fin_rel,112),103),'/','') end as DT_FIN_REL
*/
/*from tmp_wwreg_0150_0180 part*/
from TEMP_wwreg_0150_0180 part
where part.cod_rel Between '01' And '99'
order by ID_0180

/*sql*/

select
 '1' as ID_PAI
,'1' as ID

,'I010' as REG
,IND_ESC as IND_ESC
,COD_VER_LC as COD_VER_LC
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'

/*sql*/

/*
select
 '1' as ID_PAI
,'1' + '.' + eecd.estabelecimento_matriz_id as ID

,'I012' as REG
,'' as NUM_ORD
,'' as NAT_LIVRO
,'' as TIPO
,'' as COD_HASH_AUX
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '1' + '.' + eecd.estabelecimento_matriz_id as ID_PAI
,'1' + '.' + eecd.estabelecimento_matriz_id + COD_CTA_RES as ID

,'I015' as REG
,'' as COD_CTA_RES
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '1' as ID_PAI
,'1' + '.' + eecd.estabelecimento_matriz_id as ID

,'I020' as REG
,'' as REG_COD
,'' as NUM_AD
,'' as CAMPO
,'' as DESCRICAO
,'' as TIPO
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and eecd.periodo_dtini = '/*per_iniAMD*/'
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

select
 '1' as ID_PAI
,'1' as ID

,'I030' as REG
,isnull(eecd.DNRC_ABERT,'') as DNRC_ABERT
,isnull(eecd.NUM_ORD,'0') as NUM_ORD
,isnull(eecd.NAT_LIVRO,'') as NAT_LIVR
,'/*QTDLINHAS*/' as QTD_LIN
,isnull(estm.NOME,'') as NOME
,isnull(estm.NIRE,'') as NIRE
,isnull(estm.CNPJ,'') as CNPJ
,case when estm.dt_arq_atos is null then '' else replace(convert(varchar(10),convert(date,estm.dt_arq_atos,112),103),'/','') end as DT_ARQ
,case when estm.dt_conv_ss_se is null then '' else replace(convert(varchar(10),convert(date,estm.dt_conv_ss_se,112),103),'/','') end as DT_ARQ_CONV
,isnull(m.ds_municipio,'') as DESC_MUN
,case when eecd.DT_EX_SOCIAL is null then '' else replace(convert(varchar(10),convert(date,eecd.DT_EX_SOCIAL,112),103),'/','') end as DT_EX_SOCIAL
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
Left Join [0_0_pub].dbo.pub_municipios m
   on m.cd_ibge = estm.cod_mun
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'

/*sql*/

select
 '1' + '.' + eecd.estabelecimento_matriz_id + '.' + cta.COD_CTA as ID_I050
,'1' + '.' + eecd.estabelecimento_matriz_id + '.' + cta.COD_CTA + '.' + isnull(ctaref.COD_CCUS,'') + '.' + isnull(ctaref.COD_CTA_REF,cta.COD_CTA_REF) as ID_I051
,'1' as ID_PAI_I050
,replace(convert(varchar(10),convert(date,isnull(cta.INCLUSAO_DT,eecd.periodo_dtini),112),103),'/','') as DT_ALT
,isnull(cta.COD_NAT_CTA,'') as COD_NAT
,isnull(cta.IND_CTA,'') as IND_CTA
,isnull(cta.NIVEL,00) as NIVEL
,isnull(cta.COD_CTA,'') as COD_CTA
,isnull(cta.COD_CTA_SUP,'') as COD_CTA_SUP
,isnull(cta.NOME_CTA,'') as NOME_CTA
,isnull(eecd.cod_plan_ref,'1') as COD_PLAN_REF
,isnull(ctaref.COD_CCUS,'') as COD_CCUS
,isnull(ctaref.COD_CTA_REF,cta.COD_CTA_REF) as COD_CTA_REF
/*into tmp_wwreg_i050_i051*/
into TEMP_wwreg_i050_i051
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join vw_cad_contas cta
   on cta.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and cta.validade_dtini <= eecd.periodo_dtfin
  and cta.validade_dtfin >= eecd.periodo_dtini
left join conta_contasref ctaref
   on ctaref.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and ctaref.cod_cta = cta.cod_cta
  and upper(ctaref.ind_ref) = 'R'
  and ctaref.validade_dtini <= eecd.periodo_dtfin
  and ctaref.validade_dtfin >= eecd.periodo_dtini
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'

/*sql*/

select
 ID_I050 as ID
,max(ID_PAI_I050) as ID_PAI

,'I050' as REG
,max(DT_ALT) as DT_ALT
,max(COD_NAT) as COD_NAT
,max(IND_CTA) as IND_CTA
,max(NIVEL) as NIVEL
,max(COD_CTA) as COD_CTA
,max(COD_CTA_SUP) as COD_CTA_SUP
,max(NOME_CTA) as CTA
from TEMP_wwreg_i050_i051
group by ID_I050
order by 1

/*sql*/

select
 ID_I051 as ID
,ID_I050 as ID_PAI

,'I051' as REG
,COD_CCUS as COD_CCUS
,COD_CTA_REF as COD_CTA_REF
from TEMP_wwreg_i050_i051
where 1 = 1
  and IND_CTA = 'A'
order by 1

/*sql*/

/*drop table TEMP_wwreg_i050_i051*/

/*sql*/

select
 '1' + '.' + eecd.estabelecimento_matriz_id + '.' + cta.COD_CTA as ID_I050
,'1' + '.' + eecd.estabelecimento_matriz_id + '.' + cta.COD_CTA + '.' + isnull(ctaref.COD_CCUS,'') + '.' + isnull(ctaref.COD_CTA_REF,cta.COD_CTA_SUP) as ID_I052
,'1' as ID_PAI_I050
,replace(convert(varchar(10),convert(date,isnull(cta.INCLUSAO_DT,eecd.periodo_dtini),112),103),'/','') as DT_ALT
,isnull(cta.COD_NAT_CTA,'') as COD_NAT
,isnull(cta.IND_CTA,'') as IND_CTA
,isnull(cta.NIVEL,00) as NIVEL
,isnull(cta.COD_CTA,'') as COD_CTA
,isnull(cta.COD_CTA_SUP,'') as COD_CTA_SUP
,isnull(cta.NOME_CTA,'') as NOME_CTA
,isnull(eecd.cod_plan_ref,'') as COD_PLAN_REF
,isnull(ctaref.COD_CCUS,'') as COD_CCUS
,isnull(ctaref.COD_CTA_REF,cta.COD_CTA_SUP) as COD_CTA_AGL
/*into tmpaux_wwreg_i050_i052 */
into TEMP_wwreg_i050_i052
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join vw_cad_contas cta
   on cta.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and cta.validade_dtini <= eecd.periodo_dtfin
  and cta.validade_dtfin >= eecd.periodo_dtini
left join conta_contasref ctaref
   on ctaref.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and ctaref.cod_cta = cta.cod_cta
  and upper(ctaref.ind_ref) = 'A'
  and ctaref.validade_dtini <= eecd.periodo_dtfin
  and ctaref.validade_dtfin >= eecd.periodo_dtini
where 1 = 1
  and cta.ind_cta = 'A'
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'

/*sql*/

select
 ID_I052 as ID
,ID_I050 as ID_PAI

,'I052' as REG
,COD_CCUS as COD_CCUS
,COD_CTA_AGL as COD_AGL
from TEMP_wwreg_i050_i052
where 1 =1
  and IND_CTA = 'A'
order by 1

/*sql*/

/*drop table TEMP_wwreg_i050_i052*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'' as REG
,'' as COD_IDT
,'' as COD_CNT_CORR
,'' as NAT_SUB_CNT
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'' as REG
,'' as COD_HIST
,'' as DESCR_HIST
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

select
 '1' + '.' + isnull(ccus.codigo_id,'') as ID
,'1' as ID_PAI

,'I100' as REG
,replace(convert(varchar(10),convert(date,isnull(ccus.inclusao_dt,eecd.periodo_dtini),112),103),'/','') as DT_ALT
,isnull(ccus.codigo_id,'') as COD_CCUS
,isnull(ccus.descricao,'') as CCUS
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join vtx_codigos ccus
   on ccus.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and upper(ccus.tabela_cod) = 'CCUSTO'
  and ccus.validade_dtini <= eecd.periodo_dtfin
/*  and isnull(ccus.validade_dtfin,'99999999') >= eecd.periodo_dtini */
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
order by 1

/*sql*/

select
 '1' + '.' + s.periodo_dtini + '.' + s.periodo_dtfin as ID
,'1' as ID_PAI

,'I150' as REG
,replace(convert(varchar(10),convert(date,s.periodo_dtini,112),103),'/','') as DT_INI
,replace(convert(varchar(10),convert(date,s.periodo_dtfin,112),103),'/','') as DT_FIN
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join ecd_saldos s
   on s.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and substring(s.periodo_dtfin,1,4) = substring(eecd.periodo_dtfin,1,4)
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
/*
  and estm.estabelecimento_id = '001'
  and eecd.periodo_dtfin = '20221231'
*/
group by
 estm.estabelecimento_id
,s.periodo_dtini
,s.periodo_dtfin
order by 1

/*sql*/

select
 '1' + '.' + s.periodo_dtini + '.' + s.periodo_dtfin + '.' + s.cod_cta + '.' + s.cod_ccus as ID
,'1' + '.' + s.periodo_dtini + '.' + s.periodo_dtfin as ID_PAI

,'I155' as REG
,s.COD_CTA as COD_CTA
,s.COD_CCUS as COD_CCUS
     /**
       valor, virgula, decimal, aspas, tamanho do campo
      */
,dbo.Aud_Mask(abs(s.VL_SLD_INI),',',2,'',19) as VL_SLD_INI
,s.IND_DC_INI as IND_DC_INI
,dbo.Aud_Mask(abs(s.VL_DEB),',',2,'',19) as VL_DEB
,dbo.Aud_Mask(abs(s.VL_CRED),',',2,'',19) as VL_CRED
,dbo.Aud_Mask(abs(s.VL_SLD_FIN),',',2,'',19) as VL_SLD_FIN
,s.IND_DC_FIN as IND_DC_FIN
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join ecd_saldos s
   on s.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and substring(s.periodo_dtfin,1,4) = substring(eecd.periodo_dtfin,1,4)
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
/*
  and estm.estabelecimento_id = '001'
  and eecd.periodo_dtfin = '20221231'
*/
order by 1

/*sql*/

select
 '1' + '.' + s.periodo_dtini + '.' + s.periodo_dtfin + '.' + ts.cod_cta + '.' + ts.cod_ccus + '.' + ts.cod_cta_orig + '.' + ts.cod_ccus_orig as ID
,'1' + '.' + s.periodo_dtini + '.' + s.periodo_dtfin + '.' + ts.cod_cta + '.' + ts.cod_ccus as ID_PAI

,'I157' as REG
,ts.COD_CTA_ORIG as COD_CTA
,ts.COD_CCUS_ORIG as COD_CCUS
,dbo.Aud_Mask(abs(ts.VL_SLD_INI),',',2,'',19) as VL_SLD_INI
,ts.IND_DC_INI as IND_DC_INI
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join ecd_saldos s
   on s.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and substring(s.periodo_dtfin,1,4) = substring(eecd.periodo_dtfin,1,4)
inner join ecd_transfsaldos ts
   on ts.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and ts.periodo_dtfin = s.periodo_dtfin
  and ts.cod_cta = s.cod_cta
  and ts.cod_ccus = s.cod_ccus
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
order by 1

/*sql*/

select
 '1' + '.' + l.dt_lcto + '.' + l.num_lcto as ID
,'1' as ID_PAI

,'I200' as REG
,l.num_lcto as NUM_LCTO
,replace(convert(varchar(10),convert(date,max(l.dt_lcto),112),103),'/','') as DT_LCTO
,dbo.Aud_Mask(abs(sum(l.vl_dc_lcto)),',',2,'',19) as VL_LCTO
,max(case when l.ind_lcto not in ( 'E', 'X' ) then 'N' else l.ind_lcto end) as IND_LCTO
,case when len(rtrim(max(isnull(l.dt_lcto_ext,'')))) = 0 then '' else replace(convert(varchar(10),convert(date,max(l.dt_lcto_ext),112),103),'/','') end as DT_LCTO_EXT
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join ecd_lancamentos l
   on l.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and substring(l.periodo_dtfin,1,4) = substring(eecd.periodo_dtfin,1,4)
where 1 = 1
  and l.ind_dc_lcto = 'D'
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
group by
 l.dt_lcto
,l.num_lcto
order by 1

/*sql*/

select
 '1' + '.' + l.dt_lcto + '.' + l.num_lcto + '.' + rtrim(ltrim(cast(ecdlcto_idseq as varchar(12)))) as  ID
,'1' + '.' + l.dt_lcto + '.' + l.num_lcto as ID_PAI

,'I250' as REG
,cod_cta as COD_CTA
,cod_ccus as COD_CCUS
,dbo.Aud_Mask(abs(vl_dc_lcto),',',2,'',19) as VL_DC
,ind_dc_lcto as IND_DC
,num_arq as NUM_ARQ
,cod_hist_pad as COD_HIST_PAD
,hist as HIST
,isnull(partex.cod_part,'') as COD_PART
from ecd_lancamentos l
inner join estabelecimento_ecd eecd
   on eecd.estabelecimento_matriz_id = l.estabelecimento_matriz_id
  and substring(eecd.periodo_dtfin,1,4) = substring(l.dt_lcto,1,4)
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
left join
(
 Select distinct
  part.estabelecimento_matriz_id As estabelecimento_matriz_id
 ,substring(partrel.participante_id,1,9) As cod_part
 ,isnull(part.validade_dtini,'00000000') As validade_dtini
 ,isnull(part.validade_dtfin,'99999999') As validade_dtfin
 ,isnull(partrel.validade_dtini,'00000000') As validade_dtini_rel
 ,isnull(partrel.validade_dtfin,'99999999') As validade_dtfin_rel
 From vw_cad_participantes part
 Inner Join participante_relacionamentos partrel
   on part.cod_part like '%' + partrel.participante_id + '%'
 Where 1 = 1
  and part.uf = 'EX'
  and partrel.cod_rel Between '01' And '10'
) partex
   On partex.cod_part = l.cod_part
  and partex.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and partex.validade_dtini <= eecd.periodo_dtfin
  and partex.validade_dtfin >= eecd.periodo_dtini
  and partex.validade_dtini_rel <= eecd.periodo_dtfin
  and partex.validade_dtfin_rel >= eecd.periodo_dtini
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
/*  and l.dt_lcto Between '20220101' And '20221231' */
order by 1

/*sql*/

select
 '1' + '.' + isnull(s.dt_res,s.periodo_dtfin) as ID
,'1' as ID_PAI

,'I350' as REG
,replace(convert(varchar(10),convert(date,isnull(s.dt_res,s.periodo_dtfin),112),103),'/','') as DT_RES
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join ecd_saldosres s
   on s.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and substring(s.periodo_dtfin,1,4) = substring(eecd.periodo_dtfin,1,4)
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
/*  and eecd.periodo_dtfin = '20221231' */
group by
 isnull(s.dt_res,s.periodo_dtfin)
order by 1

/*sql*/

select
 '1' + '.' + isnull(s.dt_res,s.periodo_dtfin) + '.' + s.cod_cta + '.' + s.cod_ccus as ID
,'1' + '.' + isnull(s.dt_res,s.periodo_dtfin) as ID_PAI

,'I355' as REG
,s.cod_cta as COD_CTA
,s.cod_ccus as COD_CCUS
,dbo.Aud_Mask(abs(s.vl_sld_fin),',',2,'',19) as VL_CTA
,s.ind_dc_fin as IND_DC
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join ecd_saldosres s
   on s.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and substring(s.periodo_dtfin,1,4) = substring(eecd.periodo_dtfin,1,4)
left join vw_cad_contas cta
   on cta.cod_cta = s.cod_cta
  and cta.VALIDADE_DTINI <= s.dt_res
  and cta.VALIDADE_DTFIN >= s.dt_res
where 1 = 1
  and s.vl_sld_fin <> 0
  and cta.COD_NAT_CTA In ('04','05')
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
order by 1

/*sql*/

select
 '1' + '.' + dcv.periodo_dtini + '.' + dcv.periodo_dtfin as ID
,'1' as ID_PAI

,'J005' as REG
,replace(convert(varchar(10),convert(date,dcv.periodo_dtini,112),103),'/','') as DT_INI
,replace(convert(varchar(10),convert(date,dcv.periodo_dtfin,112),103),'/','') as DT_FIN
,'1' as ID_DEM
,'' as CAB_DEM
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
Inner Join ecd_demctbestrut dce
   On dce.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  And dce.validade_dtini <= eecd.periodo_dtfin
  And dce.validade_dtfin >= eecd.periodo_dtini
Inner Join ecd_demctbvalores dcv
   On dcv.estabelecimento_matriz_id = dce.estabelecimento_matriz_id
  And dcv.demctb_id = dce.demctb_id
  And dcv.cod_agl = dce.cod_agl
  And dcv.periodo_dtini <= eecd.periodo_dtfin
  And dcv.periodo_dtfin >= eecd.periodo_dtini
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
group by
 dcv.periodo_dtini
,dcv.periodo_dtfin
order by 1

/*sql*/

Select
 '1' + '.' + dcv.periodo_dtini + '-' + dcv.periodo_dtfin + '.' + dcv.demctb_id + '.' + dcv.cod_agl As ID
,'1' + '.' + dcv.periodo_dtini + '.' + dcv.periodo_dtfin as ID_PAI

,'J100' As REG
,dcv.cod_agl As COD_AGL
,MAX(dce.ind_cod_agl) As IND_COD_AGL
,CAST(MAX(dce.nivel_agl) As VARCHAR(2)) As NIVEL_AGL
,MAX(dce.cod_agl_sup) As COD_AGL_SUP
,MAX(dce.ind_grp) As IND_GRP_BAL
,MAX(dce.descr_cod_agl) As DESCR_COD_AGL
,dbo.Aud_Mask(ABS(SUM(dcv.vl_sld_ini)),',',2,'',19) As VL_CTA_INI
,Case When SUM(dcv.vl_sld_ini) >= 0 Then 'D' Else 'C' End As IND_DC_CTA_INI
,dbo.Aud_Mask(ABS(SUM(dcv.vl_sld_fin)),',',2,'',19) As VL_CTA_FIN
,Case When SUM(dcv.vl_sld_fin) >= 0 Then 'D' Else 'C' End As IND_DC_CTA_FIN
,MAX(dce.nota_exp_ref) As NOTA_EXP_REF
From estabelecimento_ecd eecd
Inner Join estabelecimentos estm
   On estm.estabelecimento_id = eecd.estabelecimento_matriz_id
Inner Join ecd_demctbestrut dce
   On dce.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  And dce.validade_dtini <= eecd.periodo_dtfin
  And dce.validade_dtfin >= eecd.periodo_dtini
Inner Join ecd_demctbvalores dcv
   On dcv.estabelecimento_matriz_id = dce.estabelecimento_matriz_id
  And dcv.demctb_id = dce.demctb_id
  And dcv.cod_agl = dce.cod_agl
  And dcv.periodo_dtini <= eecd.periodo_dtfin
  And dcv.periodo_dtfin >= eecd.periodo_dtini
Where 1 = 1
  And dce.demctb_id = 'BP'
  And dce.nivel_agl <= 9
  And estm.estabelecimento_id = '/*empresa_id_vtx*/'
  And substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  And eecd.periodo_dtfin = '/*per_finAMD*/'
/*  And estm.estabelecimento_id = '001' and eecd.periodo_dtini = '20220101' and eecd.periodo_dtfin = '20221231' */
Group By
 dce.estabelecimento_matriz_id
,dcv.periodo_dtini
,dcv.periodo_dtfin
,dcv.demctb_id
,dcv.cod_agl
Order By 1

/*sql*/

select
 '1' + '.' + dcv.periodo_dtini + '-' + dcv.periodo_dtfin + '.' + dcv.demctb_id + '.' + dcv.cod_agl As ID
,'1' + '.' + dcv.periodo_dtini + '.' + dcv.periodo_dtfin as ID_PAI

,'J150' as REG
,CAST(Case When MAX(ISNULL(dce.num_ordem,'XXXXXX')) = 'XXXXXX' Then ROW_NUMBER() OVER(PARTITION BY MAX(dce.reg) ORDER BY MAX(dce.reg) ASC) Else MAX(dce.num_ordem) End As VARCHAR(4)) As NU_ORDEM
,dcv.cod_agl As COD_AGL
,MAX(dce.ind_cod_agl) As IND_COD_AGL
,CAST(MAX(dce.nivel_agl) As VARCHAR(2)) As NIVEL_AGL
,MAX(dce.cod_agl_sup) As COD_AGL_SUP
,MAX(dce.descr_cod_agl) As DESCR_COD_AGL
,dbo.Aud_Mask(ABS(SUM(dcv.vl_sld_ini)),',',2,'',19) As VL_CTA_INI
,Case When SUM(dcv.vl_sld_ini) >= 0 Then 'D' Else 'C' End As IND_DC_CTA_INI
,dbo.Aud_Mask(ABS(SUM(dcv.vl_sld_fin)),',',2,'',19) As VL_CTA_FIN
,Case When SUM(dcv.vl_sld_fin) >= 0 Then 'D' Else 'C' End As IND_DC_CTA_FIN
,MAX(ind_grp) As IND_GRP_DRE
,MAX(dce.nota_exp_ref) As NOTA_EXP_REF
From estabelecimento_ecd eecd
Inner Join estabelecimentos estm
   On estm.estabelecimento_id = eecd.estabelecimento_matriz_id
Inner Join ecd_demctbestrut dce
   On dce.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  And dce.validade_dtini <= eecd.periodo_dtfin
  And dce.validade_dtfin >= eecd.periodo_dtini
Inner Join ecd_demctbvalores dcv
   On dcv.estabelecimento_matriz_id = dce.estabelecimento_matriz_id
  And dcv.demctb_id = dce.demctb_id
  And dcv.cod_agl = dce.cod_agl
  And dcv.periodo_dtini <= eecd.periodo_dtfin
  And dcv.periodo_dtfin >= eecd.periodo_dtini
Where 1 = 1
  And dce.demctb_id = 'DRE'
  And dce.nivel_agl <= 9
  And estm.estabelecimento_id = '/*empresa_id_vtx*/'
  And substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  And eecd.periodo_dtfin = '/*per_finAMD*/'
/*  And estm.estabelecimento_id = '001' and eecd.periodo_dtini = '20220101' and eecd.periodo_dtfin = '20221231' */
Group By
 dce.estabelecimento_matriz_id
,dcv.periodo_dtini
,dcv.periodo_dtfin
,dcv.demctb_id
,dcv.cod_agl
Order By 5

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'J210' as REG
,'' as IND_TIP
,'' as COD_AGL
,'' as DESCR_COD_AGL
,'' as VL_CTA
,'' as IND_DC_CTA
,'' as VL_CTA_INI
,'' as IND_DC_CTA_INI
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'J215' as REG
,'' as COD_HIST_FAT
,'' as VL_FAT_CONT
,'' as IND_DC_FAT
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'J800' as REG
,'' as TIPO_DOC
,'' as DESC_RTF
,'' as HASH_RTF
,'' as ARQ_RTF
,'' as IND_FIN_RTF
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'J801' as REG
,'' as TIPO_DOC
,'' as DESC_RTF
,'' as HASH_RTF
,'' as ARQ_RTF
,'' as IND_FIN_RTF
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

select
 '1' as ID
,'1' as ID_PAI

,'J900' as REG
,eecd.dnrc_encer as DNRC_ENCER
,eecd.num_ord as NUM_ORD
,eecd.nat_livro as NAT_LIVRO
,isnull(estm.NOME,'') as NOME
,'/*QTDLINHAS*/' as QTD_LIN
,replace(convert(varchar(10),convert(date,eecd.periodo_dtini,112),103),'/','') as DT_INI_ESCR
,replace(convert(varchar(10),convert(date,eecd.periodo_dtfin,112),103),'/','') as DT_FIN_ESCR
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
order by 1

/*sql*/

select
 sig.id  as ID
,'1' as ID_PAI

,'J930' as REG
,sig.ident_nom as IDENT_NOM
,sig.ident_cpf_cnpj as IDENT_CPF_CNPJ
,sig.ident_qualif as IDENT_QUALIF
,sig.cod_assin as COD_ASSIN
,isnull(ctbl.crc,'') as IND_CRC
,sig.email as EMAIL
,sig.fone as FONE
,isnull(ctbl.uf_crc,'') as UF_CRC
,isnull(ctbl.num_seq_crc,'') as NUM_SEQ_CRC
,case when len(rtrim(isnull(ctbl.dt_crc,''))) = 0 then '' else replace(convert(varchar(10),convert(date,ctbl.dt_crc,112),103),'/','') end as DT_CRC
,sig.ind_resp_legal as IND_RESP_LEGAL
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join estabelecimento_signatarios sig
   on sig.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and isnull(sig.validade_dtini,'00000000') <= eecd.periodo_dtfin
  and isnull(sig.validade_dtfin,'99999999') >= eecd.periodo_dtini
left join contabilistas ctbl
   on ctbl.cpf = sig.ident_cpf_cnpj
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
order by 1

/*sql*/

select
 aud.id as ID
,'1' as ID_PAI

,'J935' as REG
,aud.ident_cpf_cnpj as IDENT_CPF_CNPJ
,aud.nome_auditor_firma as NOME_AUDITOR
,aud.cod_cvm_auditor as COD_CVM_AUDITOR
from estabelecimento_ecd eecd
inner Join estabelecimentos estm
   on estm.estabelecimento_id = eecd.estabelecimento_matriz_id
inner join estabelecimento_auditores aud
   on aud.estabelecimento_matriz_id = eecd.estabelecimento_matriz_id
  and isnull(aud.validade_dtini,'00000000') <= eecd.periodo_dtfin
  and isnull(aud.validade_dtfin,'99999999') >= eecd.periodo_dtini
where 1 = 1
  and estm.estabelecimento_id = '/*empresa_id_vtx*/'
  and substring(eecd.periodo_dtini,1,4) = substring('/*per_iniAMD*/',1,4)
  and eecd.periodo_dtfin = '/*per_finAMD*/'
order by 1

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K010' as REG
,'' as DT_INI
,'' as DT_FIN
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K100' as REG
,'' as COD_PAIS
,'' as EMP_COD
,'' as CNPJ
,'' as NOME
,'' as PER_PART
,'' as EVENTO
,'' as PER_CONS
,'' as DT_INI
,'' as DT_FIN
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K110' as REG
,'' as EVENTO
,'' as DT_EVT
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K115' as REG
,'' as EMP_COD
,'' as COND_PART
,'' as PER_EVT
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K200' as REG
,'' as COD_NAT
,'' as IND_CTA
,'' as NIVEL
,'' as COD_CTA
,'' as COD_CTA_SUP
,'' as CTA
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K210' as REG
,'' as EMP_COD
,'' as COD_CTA_EMP
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K300' as REG
,'' as COD_CTA
,'' as VAL_AG
,'' as IND_VAL_AG
,'' as VAL_EL
,'' as IND_VAL_EL
,'' as VAL_CS
,'' as IND_VAL_CS
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K310' as REG
,'' as EMP_COD
,'' as VALOR
,'' as IND_VALOR
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/

/*sql*/

/*
select
 '' as ID
,'' as ID_PAI

,'K315' as REG
,'' as EMP_COD
,'' as COD_CONTRA
,'' as VALOR
,'' as IND_VALOR
 where estabelecimento_id = '/*empresa_id_vtx*/' and substring(eecd.periodo_dtini,1,4) = '/*per_iniAMD*/' and eecd.periodo_dtfin = '/*per_finAMD*/'
*/